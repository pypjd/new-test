# 自驾旅行复盘工具（开发中）

基于 React + TypeScript + Vite + Leaflet 的自驾复盘原型。

当前已切换为 **高德（AMap）全局地图服务**：
- 底图：高德瓦片（Leaflet `TileLayer`）
- 地名联想：高德输入提示（Input Tips）
- 路径规划：高德驾车路径规划（Driving Directions）

---

## 1. 高德 Key 申请与配置

1. 打开高德开放平台：<https://lbs.amap.com/>
2. 创建应用并开通 Web 服务，获取 Key。
3. 在项目根目录创建 `.env`：

```bash
cp .env.example .env
```

填入：

```bash
AMAP_WEB_KEY=你的高德Web服务Key
VITE_AMAP_KEY=你的高德Web服务Key（当前用于驾车规划）
```

> InputTips 通过 `/api/amap/inputtips` 代理调用，不再在浏览器直接拼接高德 key。

---

## 2. 本地运行

```bash
npm install
npm run dev
```

浏览器访问：<http://localhost:5173>

---

## 3. 使用说明

### 3.1 起点 / 终点编辑（地图占位区）

在 `3) 地图占位区` 的“起点 / 终点”区域：
- 点击 `编辑起终点`
- 输入地名后会触发高德输入提示（防抖）
- 选择候选后会写入地名和坐标，并立即触发重新规划
- 点击 `保存` 持久化到 localStorage
- 点击 `取消` 回滚到进入编辑前状态

地图里仍支持拖拽起终点 Marker（编辑轨迹模式下）：
- 拖拽后会反向更新起终点草稿坐标
- 同步触发路线重算

### 3.2 途经点 Waypoints（地名可编辑）

在 `3) 地图占位区` 的“途经点（Waypoints）”区域：
- `+ 添加`
- 每行支持地名输入 + 高德候选选择
- `上移/下移/删除`
- `定位`：地图 flyTo 并高亮该点
- `保存途经点/取消`

持久化数据结构：

```ts
Array<{ id?: string; name: string; lat: number; lng: number; amapId?: string }>
```

> 已移除“从 points 抽样生成固定 20 个途经点”的逻辑。

### 3.3 路线类型（真正生效）

在 `3) 地图占位区` 可以切换：
- 高速优先
- 避开高速
- 避免收费
- 普通道路优先
- 最短时间

切换后会立即重新调用高德驾车规划并更新 polyline。该字段随路段一并持久化。


### 3.4 地点联想（行政区优先 + 范围锁定）

- 输入关键词时会并行请求：
  - 行政区联想（`type=city`）
  - POI 联想（默认）
- 合并展示时行政区优先，POI 在后。
- 选中行政区后自动锁定范围（`citylimit=true`），后续联想优先在该城市/区县内检索。
- 可点击 `清除范围` 回到全国检索。
- 若范围内 POI 结果过少，会自动补充“范围外结果”作为回退。
- 请求有防抖、取消与乱序保护，失败时会提示“联想服务暂不可用，点击重试”。

---

## 4. 持久化

主数据存储在 localStorage：
- `trip-review-data-v1`

会持久化：
- 起点/终点地名与坐标
- 途经点列表（含坐标与顺序）
- 路线类型
- 轨迹 points（如果有）

---

## 5. 错误处理与降级

当高德路径规划失败时：
- UI 会显示失败原因（如 infocode/info 或 HTTP 状态）
- 自动降级为“直线连接”并明确提示“已降级”
- 不会静默失败

---

## 6. 常见问题

### 6.1 提示“未配置 key”

请检查：
- `.env` 是否存在
- `AMAP_WEB_KEY`（InputTips 代理）是否填写
- `VITE_AMAP_KEY`（当前驾车规划）是否填写
- 修改后是否重启了 `npm run dev`

### 6.2 接口限流 / 调用失败

- 高德免费配额或并发受限会导致请求失败
- 稍后重试，或在高德控制台查看配额与调用日志

### 6.3 无可行路线

可能原因：
- 起点/终点/途经点不完整或坐标异常
- 策略下无可行路线

系统会降级为直线并在地图提示中说明原因。
