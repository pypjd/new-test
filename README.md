# 自驾旅行复盘工具（开发中）

一个基于 React + TypeScript + Vite 的自驾旅行复盘原型，当前支持：
- 旅程/日期/路段录入与筛选
- 地图轨迹展示（OSRM 路网轨迹 + 失败回退直线）
- 起终点地名联想（Nominatim）
- 轨迹编辑（改起点/改终点/改轨迹控制点，保存/取消）
- 途经点（Waypoints）地名编辑与地图定位联动

## 本地运行

```bash
npm install
npm run dev
```

浏览器访问：<http://localhost:5173>

## 功能说明

### 1) 编辑轨迹（两个入口）

入口 A（占位区）：
- 在 `3) 地图占位区` 的“路段名称列表”中，点击某条路段右侧 `编辑轨迹`。

入口 B（地图区）：
- 在 `4) 地图轨迹` 右上角工具条点击 `编辑轨迹`。

进入编辑后支持三种模式：
- `改起点`：拖拽起点 Marker（S）
- `改终点`：拖拽终点 Marker（E）
- `改轨迹`：拖拽紫色控制点（会改变 polyline 形状）

保存与回滚：
- 点击 `保存`：写回当前数据（state + localStorage），刷新后仍生效。
- 点击 `取消`：回滚到进入编辑前状态，不落库。

### 2) 途经点（Waypoints）地名编辑

在 `3) 地图占位区` 的 “途经点（Waypoints）” 小节：
- 点击 `编辑途经点` 进入编辑状态
- 可执行：
  - `+ 添加途经点`
  - 修改地名（联想输入）
  - `上移/下移/删除`
  - `保存途经点` / `取消`
- 点击 `定位`：地图会 `flyTo` 到该途经点并高亮
- 若该途经点未解析坐标，点击 `定位` 会提示先选搜索结果

途经点来源优先级：
1. `segment.waypoints`（用户编辑结果）
2. 若为空，临时由轨迹点抽样推导（仅展示，不覆盖原 points）

### 3) 起终点联想输入

在“为日期新增路段”表单中：
- 起点、终点使用联想输入框（Nominatim Search）
- 选中候选会保存：
  - 层级地名文本
  - `startCoord` / `endCoord`
  - `startPlaceId` / `endPlaceId`
- 如果只手工输入不选候选，坐标可能缺失，地图会 fallback geocode

## 地名解析服务配置

当前默认使用 Nominatim 公共服务（无需 API key）。
如后续改为高德/腾讯，可在 `src/utils/nominatim.ts` 统一替换。

## 数据存储说明

- 主数据存储在 localStorage：`trip-review-data-v1`
- 地理编码缓存：`geoCache_v1`
- 联想查询缓存：`nominatim_query_cache_v1`

清除或重置：
- 打开浏览器 DevTools -> Application -> Local Storage
- 删除上述 key 后刷新页面

## 常见问题

1) **拖拽后没变化 / 地图不刷新**
- 确认处于编辑模式（右上角出现 `取消/保存`）。
- 确认模式切换正确（改起点/改终点/改轨迹）。
- 拖拽后点击 `保存` 才会持久化。

2) **定位失败（途经点不跳转）**
- 该途经点可能只有 name 没有 lat/lon。
- 请在编辑途经点时从联想候选中选择结果，再保存。

3) **安装依赖失败（403）**
- 说明当前网络/镜像策略限制了 npm registry。
- 在可访问 npm registry 的环境执行 `npm install` 后再运行。
